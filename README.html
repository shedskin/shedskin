<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title>Shed Skin Tutorial</title>
<meta name="date" content="Jan. 8, 2008" />
<meta name="authors" content="Mark Dufour and James Coughlan" />
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="shed-skin-tutorial">
<h1 class="title">Shed Skin Tutorial</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Version:</th>
<td>Shed Skin 0.0.26</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>Jan. 8, 2008</td></tr>
<tr><th class="docinfo-name">Authors:</th>
<td>Mark Dufour and James Coughlan</td></tr>
</tbody>
</table>
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#id1" id="id14" name="id14">Purpose of this Tutorial</a></li>
<li><a class="reference" href="#id2" id="id15" name="id15">Introduction</a></li>
<li><a class="reference" href="#id3" id="id16" name="id16">Typing Restrictions</a></li>
<li><a class="reference" href="#id4" id="id17" name="id17">Python Subset Restrictions</a></li>
<li><a class="reference" href="#id5" id="id18" name="id18">Library Limitations</a></li>
<li><a class="reference" href="#id6" id="id19" name="id19">Installation</a></li>
<li><a class="reference" href="#id7" id="id20" name="id20">Compiling and Running a Stand-Alone Program</a></li>
<li><a class="reference" href="#id8" id="id21" name="id21">Compiling an Extension Module</a></li>
<li><a class="reference" href="#id9" id="id22" name="id22">Parallel Processing</a></li>
<li><a class="reference" href="#id10" id="id23" name="id23">Calling C/C++ Code</a></li>
<li><a class="reference" href="#id11" id="id24" name="id24">Command-line Options</a></li>
<li><a class="reference" href="#id12" id="id25" name="id25">Tips and Tricks</a></li>
<li><a class="reference" href="#id13" id="id26" name="id26">How to help out in Shed Skin Development</a></li>
<li><a class="reference" href="#shed-skin-roadmap" id="id27" name="id27">Shed Skin Roadmap</a></li>
</ul>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id14" id="id1" name="id1"><span id="purpose-of-this-tutorial"></span>Purpose of this Tutorial</a></h1>
<p>This tutorial is designed to get you up and running with <strong>Shed Skin</strong>, and provides an overview of how to use it to compile and run standalone programs and modules callable from standard Python code.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id15" id="id2" name="id2"><span id="introduction"></span>Introduction</a></h1>
<p><strong>Shed Skin</strong> is an <em>experimental</em> <strong>Python-to-C++ compiler</strong> designed to speed up the execution of Python programs. It converts programs written in a <em>static subset</em> of Python to C++. The C++ code can be compiled to executable code, which can be run either as a standalone program or as a module easily imported and called from Python.</p>
<p><strong>Shed Skin</strong> uses type inference techniques to determine the <em>implicit</em> types used in a Python program, in order to generate the <em>explicit</em> type declarations needed in a C++ version. Because C++ is <em>statically typed</em>, Shed Skin requires Python code to be written such that all variables are (implicitly) statically typed.</p>
<p>Besides the <em>typing</em> and <em>subset</em> restrictions, supported programs cannot freely use the Python standard library, although the most common modules are supported, such as <tt class="docutils literal"><span class="pre">math</span></tt> and <tt class="docutils literal"><span class="pre">random</span></tt> (see <a class="reference" href="#library-limitations">Library Limitations</a>).</p>
<p>Additionally, the type inference techniques employed by <strong>Shed Skin</strong> currently do not scale very well beyond several hundred lines of code (the largest compiled program is about 1,600 lines). In all, this means that <strong>Shed Skin</strong> is currently mostly useful to compile <em>smallish</em> programs and extension modules, that do not make extensive use of dynamic Python features or the standard library.</p>
<p>Because <strong>Shed Skin</strong> is still in a very early stage of development, it can also improve a lot. At the moment, you will probably run into some bugs when using it. Please report these, so they can be fixed!</p>
<p>At the moment, <strong>Shed Skin</strong> supports GNU/Linux and Windows platforms only.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id16" id="id3" name="id3"><span id="typing-restrictions"></span>Typing Restrictions</a></h1>
<p><strong>Shed Skin</strong> translates pure, but <em>implicitly statically typed</em>, Python programs into C++. The static typing restriction means that variables can only ever have a <em>single, static type</em>. So, for example,</p>
<pre class="literal-block">
a = 1; a = ’1’ # bad
</pre>
<p>is not allowed. However, as in C++, types can be <em>abstract</em> or <em>generic</em>, so that, for example,</p>
<pre class="literal-block">
a = A(); a = B() # good
</pre>
<p>where <strong>A</strong> and <strong>B</strong> have a common base class, is allowed. (See <a class="reference" href="#tips-and-tricks">Tips and Tricks</a> for an example of a generic type.)</p>
<p>The typing restriction also means that the elements of some collection (<tt class="docutils literal"><span class="pre">list</span></tt>, <tt class="docutils literal"><span class="pre">set</span></tt>, etc.) cannot have different types (because their <em>subtype</em> must also be static). Thus:</p>
<pre class="literal-block">
a=[’apple’, ’b’, ’c’] # good
b=(1, 2, 3) # good
c=[[10.3, -2.0], [1.5, 2.3], []] # good
</pre>
<p>are allowed, but</p>
<pre class="literal-block">
d=[1, 2.5, ’abc’] # bad
e=[3, [1,2]] # bad
f=(0,’abc’,[1,2,3]) # bad
</pre>
<p>are not allowed. Of course, dictionary keys and values can be of different types:</p>
<pre class="literal-block">
g={’a’:1, ’b’:2, ’c’:3} # good
h={’a’:1, ’b’:’hello’, ’c’:[1,2,3]} # bad
</pre>
<p>In the current version of <strong>Shed Skin</strong>, mixed types are also permitted in tuples of length two:</p>
<pre class="literal-block">
a=(1, [1]) # good
</pre>
<p>In the future, mixed tuples up to a certain length will be allowed.</p>
<p><tt class="docutils literal"><span class="pre">None</span></tt> may only be mixed with non-scalar types (i.e., not with <tt class="docutils literal"><span class="pre">int</span></tt> or <tt class="docutils literal"><span class="pre">float</span></tt>):</p>
<pre class="literal-block">
l = [1]
l = None # good

m = 1
m = None # bad

def fun(x=None): pass # bad: use a special value for x here, e.g. x=-1
fun(1)
</pre>
<p>Integers and floats can often be mixed, but it is better to avoid this where possible, as it may confuse <strong>Shed Skin</strong>:</p>
<pre class="literal-block">
a = [1.0]
a = [1] # wrong - use a float here, too
</pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id17" id="id4" name="id4"><span id="python-subset-restrictions"></span>Python Subset Restrictions</a></h1>
<p><strong>Shed Skin</strong> will only ever support a subset of all Python features. The following common features are currently not supported:</p>
<blockquote>
<ul class="simple">
<li>variable numbers of arguments and keyword arguments (varargs and kwargs)</li>
<li>arbitrary-size arithmetic (integers become 32-bit on a 32-bit machine!)</li>
<li>reflection (getattr, hasattr), eval, or other really dynamic stuff</li>
<li>multiple inheritance</li>
<li>generator expressions</li>
<li>nested functions and classes</li>
<li>inheritance from builtins</li>
</ul>
</blockquote>
<p>Some other features are currently only partially supported:</p>
<blockquote>
<ul>
<li><p class="first">class attributes must always be accessed using a class identifier:</p>
<pre class="literal-block">
self.class_attr # bad
bla.class_attr # good
</pre>
</li>
<li><p class="first">anonymous function passing works reasonably well, but not for methods</p>
</li>
</ul>
</blockquote>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id18" id="id5" name="id5"><span id="library-limitations"></span>Library Limitations</a></h1>
<p>Programs to be compiled with <strong>Shed Skin</strong> cannot freely use the Python standard library. Only a handful of common modules is currently supported.</p>
<p>Note that <strong>Shed Skin</strong> can be used to build an extension module, so the main program can still use the full standard library (and of course all Python features!). See <a class="reference" href="#compiling-an-extension-module">Compiling an Extension Module</a>.</p>
<p>In general, programs can only import functionality that is defined in the <strong>Shed Skin</strong> <tt class="docutils literal"><span class="pre">lib/</span></tt> directory. The following modules are largely supported at the moment:</p>
<blockquote>
<ul class="simple">
<li>bisect</li>
<li>collections</li>
<li>copy</li>
<li>getopt</li>
<li>math</li>
<li>os (partially)</li>
<li>os.path</li>
<li>random</li>
<li>string</li>
<li>sys (partially, but including argv, exit, stdin etc.)</li>
<li>time (partially, but including time and clock)</li>
</ul>
</blockquote>
<p>For version <strong>0.1</strong> of <strong>Shed Skin</strong>, support for <tt class="docutils literal"><span class="pre">re</span></tt>, <tt class="docutils literal"><span class="pre">datetime</span></tt> and <tt class="docutils literal"><span class="pre">socket</span></tt> is planned, as well as complete support for <tt class="docutils literal"><span class="pre">os</span></tt> and <tt class="docutils literal"><span class="pre">time</span></tt>. (See <a class="reference" href="#how-to-help-out-in-shed-skin-development">How to help out in Shed Skin Development</a> if you'd like to help improve support for these or other modules.)</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id19" id="id6" name="id6"><span id="installation"></span>Installation</a></h1>
<p>The latest version of Shed Skin can be downloaded from the <a class="reference" href="http://shedskin.googlecode.com/">Googlecode site</a>. There are three types of packages available: a self-extracting Windows installer, a <strong>Debian</strong> package, and a GNU/Linux source package.</p>
<p>To install the Windows version, simply download and start it.</p>
<p>To install the <strong>Debian</strong> package, simply download and install it using your package manager.</p>
<p>To install the GNU/Linux source package, take the following steps:</p>
<blockquote>
<ul>
<li><p class="first">download and unpack it</p>
</li>
<li><p class="first">install the Boehm garbage collector; on a <strong>Debian</strong> system this is simply:</p>
<p><tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">libgc-dev</span></tt></p>
</li>
<li><p class="first">run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></tt> and place the generated <tt class="docutils literal"><span class="pre">shedskin</span></tt> file in your path</p>
</li>
</ul>
</blockquote>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id20" id="id7" name="id7"><span id="compiling-and-running-a-stand-alone-program"></span>Compiling and Running a Stand-Alone Program</a></h1>
<p>To use <strong>Shed Skin</strong> under Windows, first execute (double-click) the <tt class="docutils literal"><span class="pre">init.bat</span></tt> file in the <tt class="docutils literal"><span class="pre">shedskin-0.0.26</span></tt> directory, relative to where you installed it.  A command-line window will appear, with the current directory set to the <tt class="docutils literal"><span class="pre">shedskin-0.0.26\shedskin</span></tt> directory (hereafter referred to as the <em>Shed Skin working directory</em>).</p>
<p>Suppose we have defined a simple test program, called <tt class="docutils literal"><span class="pre">test.py</span></tt>:</p>
<pre class="literal-block">
print 'hello, world!'
</pre>
<p>To compile this program to C++, type:</p>
<pre class="literal-block">
shedskin test
</pre>
<p>This will create two C++ files, called <tt class="docutils literal"><span class="pre">test.cpp</span></tt> and <tt class="docutils literal"><span class="pre">test.hpp</span></tt>, as well as a type-annotated file called <tt class="docutils literal"><span class="pre">test.ss.py</span></tt>.</p>
<p>To create and run an executable file (called <tt class="docutils literal"><span class="pre">test.exe</span></tt> or <tt class="docutils literal"><span class="pre">test</span></tt>, depending on platform), type:</p>
<pre class="literal-block">
make run
</pre>
<p>The following output should now appear on the command line:</p>
<pre class="literal-block">
hello, world!
</pre>
<p>To only build, but not run the executable file, omit the <tt class="docutils literal"><span class="pre">run</span></tt> part:</p>
<pre class="literal-block">
make
</pre>
<p>For the executable file to execute properly under Windows, note that <tt class="docutils literal"><span class="pre">gc.dll</span></tt> (located in the Shed Skin working directory) must be located somewhere in the Windows path. This happens automatically when running <tt class="docutils literal"><span class="pre">init.bat</span></tt>.</p>
<p>As Shed Skin is still an <em>experimental</em> project and contains bugs, it is recommended that you test and debug programs thoroughly with the regular Python interpreter (<strong>CPython</strong>), before compiling them with <strong>Shed Skin</strong>. Discrepancies between <strong>CPython</strong> and <strong>Shed Skin</strong> versions should be reported as possible bugs to <tt class="docutils literal"><span class="pre">mark.dufour&#64;gmail.com</span></tt>.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id21" id="id8" name="id8"><span id="compiling-an-extension-module"></span>Compiling an Extension Module</a></h1>
<p>The ability to build extension modules is useful since it permits the use of standard, unrestricted Python code (including all libraries and the use of any standard Python programming techniques, including dynamic typing) in the main program, while still allowing the speedup of compiling the speed-critical parts by <strong>Shed Skin</strong>.</p>
<p><strong>Simple Example</strong></p>
<p>We begin with a simple example module, called <tt class="docutils literal"><span class="pre">simple_module.py</span></tt>, containing two simple functions:</p>
<pre class="literal-block">
#simple_module.py
def func1(x):
    return x+1

def func2(n):
    d=dict([(i, i*i)  for i in range(n)])
    return d

# In order for type inference to work,
# we must show Shed Skin how functions will be called:
if __name__ == '__main__':
    print func1(5)
    print func2(10)
</pre>
<p>In order for type inference to work, note that the module must (<em>indirectly</em>) call its own functions (if <tt class="docutils literal"><span class="pre">func1</span></tt> calls <tt class="docutils literal"><span class="pre">func2</span></tt>, we can omit the call to <tt class="docutils literal"><span class="pre">func2</span></tt>). This is accomplished in the example by putting the function calls in the <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__=='__main__'</span></tt> statement, so that they will not be executed when the module is imported.</p>
<p>To compile the module into an extension module, type:</p>
<pre class="literal-block">
shedskin -e simple_module
make
</pre>
<p>Depending on platform, the resulting extension module (<em>shared library</em>) is called <tt class="docutils literal"><span class="pre">simple_module.so</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyd</span></tt>.</p>
<p>The extension module can now be simply imported as usual:</p>
<pre class="literal-block">
&gt;&gt;&gt; from simple_module import func1, func2
&gt;&gt;&gt; func1(5)
6
&gt;&gt;&gt; func2(10)
{0: 0, 1: 1, 2: 4, 3: 9, 4: 16, 5: 25, 6: 36, 7: 49, 8: 64, 9: 81}
</pre>
<p>Note that calling <tt class="docutils literal"><span class="pre">func1</span></tt> with a non-integer argument causes an error:</p>
<pre class="literal-block">
&gt;&gt;&gt; func1(10.5)
Traceback (most recent call last):
  File &quot;&lt;pyshell#0&gt;&quot;, line 1, in -toplevel-
    func1(10.5)
TypeError: error in conversion to Shed Skin (integer expected)
</pre>
<p>This error would not arise in standard Python, but arises with Shed Skin since it infers <em>specific</em> argument types for each function, based on how it is called in the module.</p>
<p>It is useful to know which version of the module you are importing: either the <strong>Shed Skin</strong> version (<tt class="docutils literal"><span class="pre">simple_module.so</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyd</span></tt>) or the original Python version (<tt class="docutils literal"><span class="pre">simple_module.py</span></tt> or <tt class="docutils literal"><span class="pre">simple_module.pyc</span></tt>). One way to determine this, is to include the following code in the top of the module:</p>
<pre class="literal-block">
import sys
print sys.version
</pre>
<p><strong>Restrictions</strong></p>
<p>There are several important restrictions that must be observed when compiling an extension module:</p>
<ol class="arabic simple">
<li>Only builtin scalar and container types (<tt class="docutils literal"><span class="pre">int</span></tt>, <tt class="docutils literal"><span class="pre">float</span></tt>, <tt class="docutils literal"><span class="pre">str</span></tt>, <tt class="docutils literal"><span class="pre">list</span></tt>, <tt class="docutils literal"><span class="pre">tuple</span></tt>, <tt class="docutils literal"><span class="pre">dict</span></tt>, <tt class="docutils literal"><span class="pre">set</span></tt>) as well as <tt class="docutils literal"><span class="pre">None</span></tt> can be passed/returned. Support for custom classes will be added in a later version of <strong>Shed Skin</strong>.</li>
<li>Objects are completely converted for each call/return from <strong>Shed Skin</strong> to <strong>CPython</strong> types and back, including all of their contents. This means you cannot directly change <strong>CPython</strong> objects from the <strong>Shed Skin</strong> side and vice versa, and that conversion may become a bottleneck.</li>
<li>Global module variables are converted at module initialization time, and cannot be changed later on from the <strong>Shed Skin</strong> side.</li>
</ol>
<p><strong>Example for NumPy/SciPy users</strong></p>
<p>The following example demonstrates how a matrix created in <a class="reference" href="http://numpy.scipy.org/">NumPy</a> can be processed by a module compiled with <strong>Shed Skin</strong>. The function <tt class="docutils literal"><span class="pre">my_sum</span></tt> sums all the elements in a matrix:</p>
<pre class="literal-block">
#simple_module2.py
#function to compute sum of elements in list of lists (matrix):
def my_sum(a):
    h=len(a) #number of rows in matrix
    w=len(a[0]) #number of columns
    s=0.
    for i in range(h):
        for j in range(w):
            s += a[i][j]
    return s

# In order for type inference to work,
# we must show how functions will be (indirectly) called:
if __name__ == '__main__':
    a=[[1.,2.],[3.,4.]]
    print my_sum(a)
</pre>
<p>(This example is given purely as an illustration, since <a class="reference" href="http://numpy.scipy.org/">NumPy</a> arrays already include a built-in <tt class="docutils literal"><span class="pre">sum</span></tt> method.)</p>
<p>After compiling the module with <strong>Shed Skin</strong>, the <tt class="docutils literal"><span class="pre">my_sum</span></tt> function can now be used as follows:</p>
<pre class="literal-block">
&gt;&gt;&gt; import numpy
&gt;&gt;&gt; from simple_module import my_sum
&gt;&gt;&gt; a=numpy.array(([1.,2.],[3.,4.]))
&gt;&gt;&gt; my_sum(a.tolist())
10.0
</pre>
<p>The <tt class="docutils literal"><span class="pre">tolist</span></tt> call is necessary here, as <strong>Shed Skin</strong> does not directly support <a class="reference" href="http://numpy.scipy.org/">NumPy</a> types.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id22" id="id9" name="id9"><span id="parallel-processing"></span>Parallel Processing</a></h1>
<p>Extension modules generated by <strong>Shed Skin</strong> can be easily combined with parallel processing software such as <a class="reference" href="http://www.parallelpython.com/">Parallel Python</a> and <a class="reference" href="http://www.boddie.org.uk/python/pprocess.html">pprocess</a>.</p>
<p>Suppose we have defined the following function in a file, called <tt class="docutils literal"><span class="pre">meuk.py</span></tt>:</p>
<pre class="literal-block">
def part_sum(start, end):
    &quot;&quot;&quot;Calculates partial sum&quot;&quot;&quot;
    sum = 0
    for x in xrange(start, end):
        if x % 2 == 0:
            sum -= 1.0 / x
        else:
            sum += 1.0 / x
    return sum

if __name__ == ’__main__’:
    part_sum(1, 10)
</pre>
<p>To use this module with <a class="reference" href="http://www.parallelpython.com/">Parallel Python</a> or <a class="reference" href="http://www.boddie.org.uk/python/pprocess.html">pprocess</a>, we must first compile it into an extension module (see <a class="reference" href="#compiling-an-extension-module">Compiling an Extension Module</a>):</p>
<pre class="literal-block">
shedskin -e meuk
make
</pre>
<p><strong>Parallel Python</strong></p>
<p>To use the generated extension module with <a class="reference" href="http://www.parallelpython.com/">Parallel Python</a> &gt;= 1.5.1, simply add a pure-Python wrapper:</p>
<pre class="literal-block">
import pp

def part_sum(start, end):
    import meuk
    return meuk.part_sum(start, end)

job_server = pp.Server()
job_server.set_ncpus(2)

jobs = []
jobs.append(job_server.submit(part_sum, (1, 10000000)))
jobs.append(job_server.submit(part_sum, (10000001, 20000000)))

print sum([job() for job in jobs])
</pre>
<p><strong>pprocess</strong></p>
<p>To use the extension module with <a class="reference" href="http://www.boddie.org.uk/python/pprocess.html">pprocess</a>, follow the same approach:</p>
<pre class="literal-block">
import pprocess

def part_sum(start, end):
   import meuk
   return meuk.part_sum(start, end)

results = pprocess.Map(limit=2)
part_sum = results.manage(pprocess.MakeParallel(part_sum))

part_sum(1, 10000000)
part_sum(10000001, 20000000)

print sum(results)
</pre>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id23" id="id10" name="id10"><span id="calling-c-c-code"></span>Calling C/C++ Code</a></h1>
<p>To call manually written C/C++ code, follow these steps:</p>
<ol class="arabic">
<li><p class="first">Provide <strong>Shed Skin</strong> with enough information to perform type inference, by providing it with a <em>type model</em> of the C/C++ code. Suppose we wish to call a simple function that returns a list with the n smallest prime numbers larger than some number. The following type model, contained in a file called <tt class="docutils literal"><span class="pre">stuff.py</span></tt>, is sufficient for <strong>Shed Skin</strong> to perform type inference:</p>
<pre class="literal-block">
#stuff.py
def more_primes(n, nr=10):
    return [1]
</pre>
</li>
<li><p class="first">To actually perform type inference, create a test program, called <tt class="docutils literal"><span class="pre">test.py</span></tt>, that uses the type model, and compile it:</p>
<pre class="literal-block">
#test.py
import stuff
print stuff.more_primes(100)

shedskin test
</pre>
</li>
<li><p class="first">Besides <tt class="docutils literal"><span class="pre">test.py</span></tt>, this also compiles <tt class="docutils literal"><span class="pre">stuff.py</span></tt> to C++. Now you can fill in manual C/C++ code in <tt class="docutils literal"><span class="pre">stuff.cpp</span></tt>. But to avoid that it is overwritten the next time <tt class="docutils literal"><span class="pre">test.py</span></tt> is compiled, first move <tt class="docutils literal"><span class="pre">stuff.*</span></tt> to the <strong>Shed Skin</strong> <tt class="docutils literal"><span class="pre">lib/</span></tt> dir.</p>
</li>
</ol>
<p><strong>Standard Library</strong></p>
<p>By moving <tt class="docutils literal"><span class="pre">stuff.*</span></tt> to <tt class="docutils literal"><span class="pre">lib/</span></tt>, we have in fact added support for an arbitrary module to <strong>Shed Skin</strong>. Other programs compiled by <strong>Shed Skin</strong> can now import <tt class="docutils literal"><span class="pre">stuff</span></tt> and use <tt class="docutils literal"><span class="pre">more_primes</span></tt>. There is no difference with adding support for a <em>standard library</em> module. In fact, in the <tt class="docutils literal"><span class="pre">lib/</span></tt> directory, you can find type models and implementations for all supported modules (see <a class="reference" href="#library-limitations">Library Limitations</a>). As you may notice, some have been partially converted to C++ using <strong>Shed Skin</strong>.</p>
<p><strong>Shed Skin Types</strong></p>
<p><strong>Shed Skin</strong> reimplements the Python builtins with its own set of C++ classes, built on the C++ Standard Template Library. They have a similar interface, so they should be easy to use (provided you have some basic C++ knowledge.) See the class definitions in <tt class="docutils literal"><span class="pre">lib/builtin.hpp</span></tt> for details. If in doubt, convert some equivalent Python code to C++, and have a look at the result.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id24" id="id11" name="id11"><span id="command-line-options"></span>Command-line Options</a></h1>
<p>The <tt class="docutils literal"><span class="pre">shedskin</span></tt> command has the following options:</p>
<pre class="literal-block">
-b --bounds             Enable bounds checking
-e --extmod             Generate extension module
-f --flags              Provide alternative Makefile flags
-n --nowrap             Disable wrap-around checking
-i --infinite           Try to avoid infinite analysis time
</pre>
<p>(To see an up-to-date list of these options simply type <tt class="docutils literal"><span class="pre">shedskin</span></tt> without any argument.)</p>
<p>For example, to use the bounds checking option to compile <tt class="docutils literal"><span class="pre">test.py</span></tt>, type <tt class="docutils literal"><span class="pre">shedskin</span> <span class="pre">–b</span> <span class="pre">test</span></tt> or <tt class="docutils literal"><span class="pre">shedskin</span> <span class="pre">––bounds</span> <span class="pre">test</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">--bounds</span></tt> option is used to catch index out-of-bounds errors in lists, tuples and strings, which would produce errors in <strong>CPython</strong>.  Without it, the following erroneous code would give a spurious value rather than reporting an error:</p>
<pre class="literal-block">
a=[1,2,3]
print a[5] # invalid index: out of bounds
</pre>
<p>The <tt class="docutils literal"><span class="pre">--nowrap</span></tt> option can speed up program execution by a modest amount, at the risk of giving wrong values for negative indices (<tt class="docutils literal"><span class="pre">a[-1]</span></tt> in the above example.) Before using this option, make sure that your code will run safely with it.</p>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id25" id="id12" name="id12"><span id="tips-and-tricks"></span>Tips and Tricks</a></h1>
<p><strong>Tips</strong></p>
<ol class="arabic simple">
<li>When recompiling an extension module, <tt class="docutils literal"><span class="pre">make</span></tt> will fail if the <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file can’t be overwritten. This problem may occur when using <strong>IPython</strong>: after importing a module, it is impossible to overwrite the <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file as long as <strong>IPython</strong> is kept open.</li>
<li>If you modify a module after compiling it with <strong>Shed Skin</strong>, you may find yourself unable to import the new version (e.g. to test it in <strong>CPython</strong> before recompiling with Shed Skin) until you delete the corresponding <tt class="docutils literal"><span class="pre">.pyd</span></tt> or <tt class="docutils literal"><span class="pre">.so</span></tt> file.</li>
<li>Shed Skin takes the flags it sends to the C++ compiler from the <tt class="docutils literal"><span class="pre">FLAGS</span></tt> file in the Shed Skin working directory. These flags can be overridden by creating a local file with the same name.</li>
</ol>
<p><strong>Tricks</strong></p>
<ol class="arabic">
<li><p class="first">The used type inference techniques can end up in an infinite loop, especially for larger programs. If this happens, it sometimes helps to run <strong>Shed Skin</strong> with the <tt class="docutils literal"><span class="pre">--infinite</span></tt> command-line option.</p>
</li>
<li><p class="first">The following two code fragments work the same, but only the second one is supported:</p>
<pre class="literal-block">
statistics = {'nodes': 28, 'solutions': set()}

class statistics: pass
s = statistics(); s.nodes = 28; s.solutions = set()
</pre>
</li>
<li><p class="first">The evaluation order of arguments to a function or <tt class="docutils literal"><span class="pre">print</span></tt> changes with translation to C++, so it's better not to depend on this:</p>
<pre class="literal-block">
print 'hoei', raw_input() # raw_input is called first!
</pre>
</li>
<li><p class="first">Tuples with different types of elements and length &gt; 2 are not supported. It can however be useful to 'simulate' them:</p>
<pre class="literal-block">
a = (1, '1', 1.0) # bad
a = (1, ('1', 1.0)) # good
</pre>
</li>
<li><p class="first">The following example shows how to model a <em>generic</em> type:</p>
<pre class="literal-block">
class matrix:
    def __init__(self, hop):
        self.unit = hop

m1 = matrix([1])
m2 = matrix([1.0])
</pre>
</li>
</ol>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id26" id="id13" name="id13"><span id="how-to-help-out-in-shed-skin-development"></span>How to help out in Shed Skin Development</a></h1>
<p>Open source projects, especially new ones such as <strong>Shed Skin</strong>, thrive on user feedback. Please send in bug reports (email: <tt class="docutils literal"><span class="pre">mark.dufour&#64;gmail.com</span></tt>), patches or other code, or suggestions about this document; or join the mailing list and start or participate in discussions (see the <a class="reference" href="http://shedskin.googlecode.com/">Googlecode site</a>.)</p>
<p>If you are a student, you might want to consider applying for the yearly Google <a class="reference" href="http://code.google.com/soc/">Summer of Code</a> or <a class="reference" href="http://code.google.com/opensource/ghop/">GHOP</a> projects. <strong>Shed Skin</strong> has so far successfully participated in one Summer of Code and one GHOP.</p>
<p>The following company/people deserve to be mentioned for their help with <strong>Shed Skin</strong> so far:</p>
<ul class="simple">
<li>Google</li>
<li>Bearophile</li>
<li>Paul Boddie</li>
<li>James Coughlan</li>
<li>Luis M. Gonzales</li>
<li>Denis de Leeuw Duarte</li>
<li>Jeff Miller</li>
<li>Harri Pasanen</li>
</ul>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id27" id="shed-skin-roadmap" name="shed-skin-roadmap"><span id="roadmap"></span>Shed Skin Roadmap</a></h1>
<p>The following activities are planned for future versions of <strong>Shed Skin</strong>:</p>
<p><strong>0.1</strong> (6-12 months from now)</p>
<ul class="simple">
<li>Add complete support for the <tt class="docutils literal"><span class="pre">re</span></tt>, <tt class="docutils literal"><span class="pre">socket</span></tt> and <tt class="docutils literal"><span class="pre">datetime</span></tt> modules, and all modules mentioned in <a class="reference" href="#library-limitations">Library Limitations</a>.</li>
<li>Improve the type inference techniques with at least <em>iterative deepening</em> and basic selector-based <em>filters</em>.</li>
<li>Compile at least one program of around 3,000 lines, for example <a class="reference" href="http://quameon.sourceforge.net/">Quameon</a>.</li>
<li>Split up the compiler core.</li>
</ul>
<p><strong>0.2</strong> (12-24 months from now)</p>
<ul class="simple">
<li>Replace many quick hacks in the compiler core</li>
<li>Perform several major cleanups.</li>
<li>Improve readability of generated code.</li>
<li>Locate bugs using some Python regression test suite, and fix them.</li>
<li>Improve packaging of generated code</li>
<li>Add support for tuples with mixed elements up to a certain length</li>
</ul>
<p><strong>0.9</strong> (18-36 months from now)</p>
<ul class="simple">
<li>Efficient and complete extension module support.</li>
<li><strong>Shed Skin</strong> <tt class="docutils literal"><span class="pre">set</span></tt> type performs at least as efficiently as CPython <tt class="docutils literal"><span class="pre">set</span></tt>.</li>
<li>Improve type inference to the point where it works for typical, arbitrary programs of around 3,000 lines.</li>
<li>Add support for multiple inheritance, generator expressions and nested functions</li>
<li>Add basic stack allocation, out-of-bounds and wrap-around optimizations.</li>
</ul>
</div>
</div>
</body>
</html>
